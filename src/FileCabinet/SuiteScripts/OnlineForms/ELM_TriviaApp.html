<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Juga y Gana</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap');
    :root {
      /* enlamano palette */
      --bg-start: #5b1fa8; /* deep purple */
      --bg-end: #380b6a;   /* darker purple */
      --surface: #ffffff;
      --text: #1b1330;
      --muted: #7a6b92;
      --primary: #ff7a00; /* orange CTA */
      --primary-600: #ff7300;
      --accent: #ff7a00;
      --error: #ef4444;
      --warning: #f59e0b;
      --ring: rgba(255,122,0,0.15);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Poppins, Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      color: var(--text);
      background: linear-gradient(180deg, rgba(91,31,168,0.95) 0%, rgba(56,11,106,0.95) 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 28px 16px; /* tighten outer padding so no large white band shows */
      min-height: 100vh;
    }
    .app {
      /* Make the outer wrapper transparent so the background gradient shows;
         keep layout simple and let the .card provide the white surface. */
      width: 100%;
      background: transparent;
      border-radius: 0;
      box-shadow: none;
      overflow: visible;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0;
      max-width: none;
    }
    /* two-column layout */
  /* single-card centered layout (hero removed per user request) */
  .layout { display: flex; justify-content: center; align-items: center; padding: 28px; }
  .card { background: var(--surface); border-radius: 18px; padding: 18px; box-shadow: 0 22px 40px rgba(10,8,20,0.20); width: 460px; max-width: calc(100% - 48px); min-height: 560px; overflow: hidden; }
  .card-header { display:flex; justify-content:flex-start; align-items:center; padding: 12px 16px 6px 16px; }
    @media (max-width: 880px) {
      .layout { flex-direction: column; padding: 18px; }
      .card { margin-top: 18px; width: 100%; max-width: calc(100% - 40px); }
    }
    header.app-header {
      padding: 18px 24px 14px;
      border-bottom: 1px solid rgba(20,16,36,0.04);
    }
    .title {
      margin: 0 0 6px;
      font-size: 26px;
      letter-spacing: .2px;
      font-weight: 700;
    }
  .brand-logo { width: 220px; height: 64px; display:block; object-fit: contain; object-position: left center; }
    /* If the remote image fails to load, show a simple text fallback using CSS background color and hidden alt text shown visually */
    .brand-logo[alt] { font-size: 0; }
    .brand-logo.fallback {
      background: linear-gradient(90deg, var(--bg-start), var(--bg-end));
      color: #fff; display: inline-flex; align-items: center; justify-content: center; font-weight:700;
      width: 220px; height: 64px; border-radius: 8px; font-size: 18px;
    }
    .subtitle {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }

  .content { padding: 6px 12px 18px 12px; }
  .views { position: relative; min-height: 440px; padding: 6px 4px; }
    .view {
      position: absolute; inset: 0;
      opacity: 0; transform: translateY(8px);
      pointer-events: none;
      transition: opacity .28s ease, transform .28s ease;
    }
    .view.active { opacity: 1; transform: translateY(0); pointer-events: auto; }

  .grid { display: grid; gap: 14px; }
  /* Ensure grid children can shrink and don't force overflow */
  .grid > * { min-width: 0; }
  @media (min-width: 700px) { .grid.cols-2 { grid-template-columns: 1fr 1fr; } }
  /* Prevent the right column from overflowing visually by constraining internal elements */
  .grid.cols-2 > .field { width: 100%; }
  .actions { justify-content: center; }

    label { font-size: 12px; color: var(--muted); display: block; margin: 2px 0 6px; }
    .field { display: flex; flex-direction: column; }
    input[type="text"], input[type="tel"] {
      padding: 12px 14px;
      border: 1px solid rgba(20,16,36,0.06);
      border-radius: 12px;
      outline: none;
      font-size: 15px;
      transition: border-color .12s ease, box-shadow .12s ease, transform .06s ease;
      background: rgba(250,250,252,0.9);
      width: 100%;
      box-sizing: border-box;
      min-width: 0; /* allow flex/grid children to shrink */
    }
    input[type="text"]:focus, input[type="tel"]:focus {
      border-color: var(--primary);
      box-shadow: 0 6px 18px rgba(88,0,140,0.08), 0 0 0 6px var(--ring);
      transform: translateY(-0.5px);
    }
    .invalid input { border-color: var(--error); }
    .form-error { color: var(--error); font-size: 13px; min-height: 18px; }

    .actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 10px; }
    .btn {
      appearance: none;
      border: 0; border-radius: 10px;
      padding: 10px 14px;
      font-weight: 600; font-size: 14px;
      cursor: pointer;
      transition: transform .05s ease, background-color .2s ease, box-shadow .2s ease;
    }
    .btn:active { transform: translateY(1px); }
  .btn-primary { background: var(--primary); color: #fff; box-shadow: 0 10px 30px rgba(255,122,0,0.18); border-radius: 999px; padding: 12px 20px; }
  .btn-primary:hover { background: var(--primary-600); transform: translateY(-1px); }
  .btn-primary:active { transform: translateY(0); }
    .btn-ghost { background: #f3f4f6; color: #111827; }
    .btn-ghost:hover { background: #e5e7eb; }
    .btn-success { background: var(--accent); color: #fff; }
    .btn-danger { background: var(--error); color: #fff; }
    .btn[disabled] { opacity: .55; cursor: not-allowed; box-shadow: none; }

  .progress { height: 8px; background: #f3f4f6; border-radius: 999px; overflow: hidden; }
    .progress .bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), #60a5fa); transition: width .25s ease; }
    .progress-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .progress-text { font-size: 12px; color: var(--muted); }

    .question { font-size: 18px; font-weight: 700; margin: 12px 0 12px; }
    .options { display: grid; gap: 10px; margin: 6px 0 6px; }
    .option {
      display: flex; align-items: center; gap: 10px;
      width: 100%; text-align: left;
      border: 1px solid #e5e7eb; border-radius: 12px;
      padding: 12px 14px; background: #fff; color: inherit;
    }
    .option:hover { border-color: var(--primary); box-shadow: 0 0 0 4px var(--ring); }
    .option.selected { border-color: var(--primary); background: #f0f6ff; }

    .muted { color: var(--muted); font-size: 13px; }
  .kpi { display: flex; align-items: baseline; gap: 8px; margin: 10px 0 6px; }
  .kpi .big { font-size: 36px; font-weight: 800; color: var(--primary); }
    .kpi .tag { font-size: 12px; padding: 4px 8px; border-radius: 999px; }
    .tag.success { background: #dcfce7; color: #166534; }
    .tag.warn { background: #fef3c7; color: #92400e; }
    .tag.error { background: #fee2e2; color: #991b1b; }

    .save-status { margin-top: 12px; font-size: 14px; }
    .spinner {
      display: inline-block; width: 14px; height: 14px; border-radius: 999px;
      border: 2px solid rgba(255,122,0,0.18); border-top-color: var(--primary);
      animation: spin .7s linear infinite; vertical-align: text-bottom; margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @keyframes shake { 10%, 90% {transform: translateX(-1px);} 20%, 80% {transform: translateX(2px);} 30%, 50%, 70% {transform: translateX(-4px);} 40%, 60% {transform: translateX(4px);} }
    .shake { animation: shake .4s; }

    @media (prefers-reduced-motion: reduce) {
      .view { transition: none; }
      .option:hover { box-shadow: none; }
      .btn { transition: none; }
    }
  </style>
</head>
<body>
  <NLFORM>
  <main class="app" role="main" aria-label="Aplicación de Trivia Interactiva">
    <div class="layout">
      <aside class="card">
        <div class="card-header">
          <img src="https://7564430-sb1.app.netsuite.com/core/media/media.nl?id=140&c=7564430_SB1&h=giXsmMiQ5bldOX3Prd7fI-4xM8BjyFNkBs72PQ6JyD8Hac0a" alt="en la mano" class="brand-logo" id="brandLogo" />
        </div>

        <section class="content">
          <div class="views">
        <!-- 1) Formulario de registro -->
        <div id="view-form" class="view active" aria-labelledby="form-title">
          <h2 id="form-title" class="sr-only" style="position:absolute;left:-9999px;">Formulario de registro</h2>
          <form id="registerForm" novalidate>
            <div class="grid cols-2">
              <div class="field" id="field-nombre">
                <label for="nombre">Nombre</label>
                <!-- <input type="text" id="nombre" name="nombre" placeholder="Ej.: Ana" required /> -->
                <NLFIRSTNAME></NLFIRSTNAME>
              </div>
              <div class="field" id="field-apellido">
                <label for="apellido">Apellido</label>
               <!--  <input type="text" id="apellido" name="apellido" placeholder="Ej.: Pérez" required /> -->
                <NLLASTNAME></NLLASTNAME>
              </div>
              <div class="field" id="field-cedula">
                <label for="cedula">Cédula (sin puntos, ni guiones)</label>
                <!-- <input type="text" id="cedula" name="cedula" placeholder="Ej.: 4.123.456-7" required /> -->
                <NLCUSTENTITY_SDB_NRDOCUMENTO></NLCUSTENTITY_SDB_NRDOCUMENTO>
                
              </div>
              <div class="field" id="field-telefono">
                <label for="telefono">Teléfono</label>
                <!-- <input type="tel" id="telefono" name="telefono" placeholder="Ej.: 091234567" inputmode="tel" required /> -->
                <NLPHONE></NLPHONE>
              </div>
            </div>
            <div id="formError" class="form-error" aria-live="polite"></div>
            <div class="actions">
              <!-- Make this a non-submitting button so NetSuite doesn't interpret it as final submit -->
              <button type="button" class="btn btn-primary" id="btnStart">Comenzar</button>
            </div>
          </form>
        </div>

        <!-- 2) Vista de preguntas -->
        <div id="view-quiz" class="view" aria-labelledby="quiz-title" aria-live="polite">
          <div class="progress-row">
            <div class="progress" style="flex:1; margin-right: 12px;">
              <div id="progressBar" class="bar"></div>
            </div>
            <div id="progressText" class="progress-text">Pregunta 1 de 5</div>
          </div>
          <div class="question" id="questionText">Pregunta aparecerá aquí</div>
          <div class="options" id="options"></div>
          <div class="actions">
            <button type="button" class="btn btn-primary" id="btnNext" disabled>Siguiente</button>
          </div>
          <p class="muted" id="helperText"></p>
        </div>

        <!-- 3) Vista de resultado -->
        <div id="view-result" class="view" aria-labelledby="result-title">
          <h2 id="result-title" class="sr-only" style="position:absolute;left:-9999px;">Resultado</h2>
          <div class="kpi">
            <span class="big" id="scoreValue">0/0</span>
            <span id="scorePercent" class="muted">0%</span>
            <span id="scoreTag" class="tag">—</span>
          </div>
          <p id="scoreMessage" style="margin-top: 2px; font-weight: 600;"></p>

          <div class="save-status" id="saveStatus" aria-live="polite"></div>

          <div class="actions">
            <button type="button" class="btn btn-success" id="btnRetrySend" style="display:none;">Reintentar envío</button>
            <button type="button" class="btn btn-ghost" id="btnRestart">Volver a empezar</button>
          </div>
          </div> <!-- .views -->
        </section> <!-- .content inside card -->
      </aside> <!-- .card -->
    </div> <!-- .layout -->
  </main>

  <script>
    console.log('TriviaApp: script loaded');
    // ===== Preguntas (fácil de ampliar) =====
    // Agregue o edite elementos en este arreglo. Cada pregunta tiene 3 opciones y el índice de la correcta.
    const preguntas = [
      {
        pregunta: "¿Cuál es la capital de Uruguay?",
        opciones: ["Montevideo", "Buenos Aires", "Asunción"],
        correcta: 0
      },
      {
        pregunta: "¿Cuántos departamentos tiene Uruguay?",
        opciones: ["19", "21", "17"],
        correcta: 0
      },
      {
        pregunta: "¿Cuál es la moneda oficial de Uruguay?",
        opciones: ["Peso uruguayo", "Real", "Peso argentino"],
        correcta: 0
      },
      {
        pregunta: "¿Cuál es el deporte más popular en Uruguay?",
        opciones: ["Fútbol", "Rugby", "Básquetbol"],
        correcta: 0
      },
      {
        pregunta: "¿Qué colores predominan en la bandera de Uruguay?",
        opciones: ["Azul y blanco con sol", "Rojo y blanco", "Verde y amarillo"],
        correcta: 0
      }
    ];

  // ===== Configuración del RESTlet =====
  // Reemplace XXX por el ID interno del script del RESTlet (y el deploy si corresponde)
  const RESTLET_SCRIPT_ID = '36';
  const RESTLET_DEPLOY_ID = '1';
  const RESTLET_ACCOUNT_ID = '7564430_SB1';
  const RESTLET_BASE_PATH = '/app/site/hosting/restlet.nl';
  // Si el formulario está hospedado en NetSuite (app/extforms) dejá vacío para que use location.origin
  // En caso de probar desde otro dominio podés forzar el host, por ejemplo:
  // Para usar la URL externa provista por NetSuite podés sobrescribir el host como sigue.

  // ===== Opcionales: Credenciales OAuth (CLIENT-SIDE, INSECURE) =====
  // WARNING: Storing these values in the browser exposes them to anyone who can open
  // the page. Prefer a server-side proxy. These are provided here because you asked
  // for an in-HTML example that generates the Authorization header and sends it in
  // the fetch. Replace the placeholder strings with real values if you accept the risk.
    const url = 'https://7564430-sb1.restlets.api.netsuite.com/app/site/hosting/restlet.nl';

    this.credentials = {
      tokenId: '038083591f7f4251dd01dc03992bcae3be4064be164d0648f3695c999d2835a0',
      tokenSecret: 'fff3845505005454647320d38115e06e8d191a4367416a4f131242cfe647ad51',  // From Postman collection
      consumerKey: 'b7335b8ac48924318c704a2e0948d26d9a3d7bf79ee17c79e46031aca97041f4',
      consumerSecret: 'ed0ed5df6e0aeb850569b5e6b6c5ebd61213345d79baa3ffefe24eb05ca9f901',
      realm: '7564430_SB1'
    };


  // ===== OAuth 1.0a (HMAC-SHA256) helpers (browser, uses Web Crypto) =====
  function percentEncode(str) {
    return encodeURIComponent(str)
      .replace(/[!*()']/g, c => '%' + c.charCodeAt(0).toString(16).toUpperCase());
  }

  function generateNonce(len = 32) {
    const arr = new Uint8Array(len);
    crypto.getRandomValues(arr);
    return Array.from(arr).map(n => (n % 36).toString(36)).join('');
  }

  function arrayBufferToBase64(buffer) {
    const bytes = new Uint8Array(buffer);
    let binary = '';
    const chunkSize = 0x8000;
    for (let i = 0; i < bytes.length; i += chunkSize) {
      binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunkSize));
    }
    return btoa(binary);
  }




  function buildUrl(baseURL, script, deploy, scriptParams = '') {
    const u = new URL(baseURL || this.baseURL);
    u.searchParams.set('script', String(script));
    u.searchParams.set('deploy', String(deploy));

    if (typeof scriptParams === 'string' && scriptParams.trim()) {
      for (const pair of scriptParams.replace(/^\?*&*/, '').split('&')) {
        if (!pair) continue;
        const [k, v = ''] = pair.split('=');
        u.searchParams.set(decodeURIComponent(k), decodeURIComponent(v));
      }
    }
    return u.toString();
  }
  // Generic HMAC using Web Crypto. algoName is 'SHA-256' or 'SHA-1'
  async function hmac(key, data, algoName = 'SHA-256') {
    const enc = new TextEncoder();
    const cryptoKey = await crypto.subtle.importKey('raw', enc.encode(key), { name: 'HMAC', hash: algoName }, false, ['sign']);
    const sig = await crypto.subtle.sign('HMAC', cryptoKey, enc.encode(data));
    return arrayBufferToBase64(sig);
  }

  // Build OAuth 1.0a Authorization header
  // method: 'POST', url: full URL (may include query), body: string or null
  /**
   * Genera el Authorization header OAuth 1.0a HMAC-SHA256 para NetSuite
   * - Si hay librería oauth-1.0a, la usa.
   * - Si no, firma manualmente incluyendo los QUERY PARAMS en la base string.
   */
  async function buildOAuthHeader({ url, method = 'POST' }) {
    const { realm, consumerKey, consumerSecret, tokenId, tokenSecret } = this.credentials;

    // Puedes usar timestamp del server para evitar drift (opcional):
    // const ts = await this.getServerTimestamp();
    const ts = Math.floor(Date.now() / 1000).toString();
    const nonce = crypto.randomBytes(10).toString('hex');

    // 1) Con librería (recomendado)
    if (OAuth) {
      const oauth = OAuth({
        consumer: { key: consumerKey, secret: consumerSecret },
        signature_method: 'HMAC-SHA256',
        hash_function(baseString, key) {
          return crypto.createHmac('sha256', key).update(baseString).digest('base64');
        },
      });
      const token = { key: tokenId, secret: tokenSecret };
      const custom = { oauth_timestamp: ts, oauth_nonce: nonce };
      const authData = oauth.authorize({ url, method }, token, custom);
      const { Authorization } = oauth.toHeader(authData);
      return `${Authorization}, realm="${realm}"`;
    }

    // 2) Fallback manual (incluye query params en la firma)
    const u = new URL(url);
    const oauthData = {
      oauth_consumer_key: consumerKey,
      oauth_nonce: nonce,
      oauth_signature_method: 'HMAC-SHA256',
      oauth_timestamp: ts,
      oauth_token: tokenId,
      oauth_version: '1.0',
    };

    // Recolectar todos los params: query + oauth (realm NO va)
    const allParams = [];
    for (const [k, v] of u.searchParams.entries()) {
      allParams.push([k, v]);
    }
    for (const [k, v] of Object.entries(oauthData)) {
      allParams.push([k, v]);
    }

    // Orden lexicográfico por nombre y luego valor
    allParams.sort((a, b) => (a[0] === b[0] ? String(a[1]).localeCompare(String(b[1])) : a[0].localeCompare(b[0])));

    const paramString = allParams.map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');

    const baseString = [
      method.toUpperCase(),
      encodeURIComponent(`${u.origin}${u.pathname}`),
      encodeURIComponent(paramString),
    ].join('&');

    const signingKey = `${encodeURIComponent(consumerSecret)}&${encodeURIComponent(tokenSecret)}`;
    const signature = crypto.createHmac('sha256', signingKey).update(baseString).digest('base64');

    const headerParams = { ...oauthData, oauth_signature: signature };
    const headerString = Object.keys(headerParams)
      .sort()
      .map((k) => `${encodeURIComponent(k)}="${encodeURIComponent(headerParams[k])}"`)
      .join(', ');

    return `OAuth ${headerString}, realm="${realm}"`;
  }


    class TriviaApp {
      constructor(preguntas) {
        this.preguntas = preguntas;
        this.state = {
          idx: 0,
          respuestas: Array(preguntas.length).fill(null),
          puntaje: 0,
          participante: null,
          guardando: false,
        };

        // Vistas
        this.viewForm = document.getElementById('view-form');
        this.viewQuiz = document.getElementById('view-quiz');
        this.viewResult = document.getElementById('view-result');

  // Formulario
  // In some environments (preview/outside NetSuite) the form element may not exist.
  // Use document as fallback so querySelector still works, and guard later calls that require an actual form.
  const formContainer = document.getElementById('registerForm') || document;
  this.form = document.getElementById('registerForm') || null;
  // Helper: robustly find the actual input/select/textarea for a given field container
  const findInputForField = (fieldId, nameHints=[]) => {
    // 1) try explicit id on input
    const byId = document.getElementById(fieldId);
    if (byId && (byId.tagName && /input|textarea|select/i.test(byId.tagName))) return byId;
    // 2) look inside container for input/select/textarea
    const container = document.getElementById(`field-${fieldId}`) || document.getElementById(`field-${fieldId.toLowerCase()}`) || document.getElementById(fieldId);
    if (container && container.querySelector) {
      const first = container.querySelector('input, textarea, select');
      if (first) return first;
    }
    // 3) search by common name patterns inside the whole form container
    for (const hint of nameHints) {
      const byName = formContainer.querySelector(`input[name*="${hint}" i], textarea[name*="${hint}" i], select[name*="${hint}" i]`);
      if (byName) return byName;
    }
    // 4) fallback: any input inside the field container id if present
    if (container && container.querySelector) return container.querySelector('*');
    return null;
  };

  // The NL* placeholders may render inputs with different ids. Use the helper to locate the first real input.
  this.$nombre = findInputForField('nombre', ['firstname','first','nombre']);
  this.$apellido = findInputForField('apellido', ['lastname','last','apellido']);
  this.$cedula = findInputForField('cedula', ['documento','nrdocumento','cedula','id']);
  this.$telefono = findInputForField('telefono', ['phone','telefono','mobile','cel']);
  this.formError = document.getElementById('formError');
  // Helpful console warnings for debugging when the expected ids are not present
  if (!this.$nombre) console.debug('TriviaApp: input for nombre not found');
  if (!this.$apellido) console.debug('TriviaApp: input for apellido not found');
  if (!this.$cedula) console.debug('TriviaApp: input for cedula not found');
  if (!this.$telefono) console.debug('TriviaApp: input for telefono not found');

        // Quiz
        this.$progressBar = document.getElementById('progressBar');
        this.$progressText = document.getElementById('progressText');
        this.$questionText = document.getElementById('questionText');
        this.$options = document.getElementById('options');
        this.$btnNext = document.getElementById('btnNext');
        this.$helper = document.getElementById('helperText');

        // Resultados
        this.$scoreValue = document.getElementById('scoreValue');
        this.$scorePercent = document.getElementById('scorePercent');
        this.$scoreTag = document.getElementById('scoreTag');
        this.$scoreMessage = document.getElementById('scoreMessage');
        this.$saveStatus = document.getElementById('saveStatus');
        this.$btnRetrySend = document.getElementById('btnRetrySend');
        this.$btnRestart = document.getElementById('btnRestart');
      }

      init() {
        console.log('TriviaApp: init()');
        this.bindForm();
        this.bindQuiz();
        this.bindResult();
        // Bind the start button to a non-submitting handler so NetSuite doesn't close the form
        const startBtn = document.getElementById('btnStart');
        if (startBtn) {
          console.log('TriviaApp: found #btnStart, attaching click listener');
          startBtn.addEventListener('click', () => this.handleStart());
        } else {
          console.warn('TriviaApp: #btnStart not found. Installing delegated click listener as fallback.');
          // delegated fallback in case NetSuite wraps or replaces the button
          document.addEventListener('click', (ev) => {
            const b = ev.target.closest && ev.target.closest('#btnStart');
            if (b) {
              console.log('TriviaApp: delegated click on #btnStart detected');
              this.handleStart();
            }
          });
        }
        this.showView('form');
        // Observe DOM mutations to catch NetSuite client-side replacements of NL tags
        const mo = new MutationObserver((mutations) => {
          if (document.getElementById('btnStart')) {
            console.log('TriviaApp: detected #btnStart via MutationObserver, attaching listener');
            const b = document.getElementById('btnStart');
            b.addEventListener('click', () => this.handleStart());
            mo.disconnect();
          }
        });
        mo.observe(document.body, { childList: true, subtree: true });
      }

      // ----- Navegación entre vistas -----
      showView(name) {
        [this.viewForm, this.viewQuiz, this.viewResult].forEach(v => v.classList.remove('active'));
        if (name === 'form') this.viewForm.classList.add('active');
        if (name === 'quiz') this.viewQuiz.classList.add('active');
        if (name === 'result') this.viewResult.classList.add('active');
      }

      // ----- Formulario -----
      bindForm() {
        // Keep the form submit handler as a fallback but primary flow uses the start button
        if (this.form && typeof this.form.addEventListener === 'function') {
          this.form.addEventListener('submit', (e) => {
            e.preventDefault();
            const ok = this.validateForm();
            if (!ok) return;
            this.startQuizFromForm();
          });
        } else {
          console.warn('TriviaApp: no #registerForm found; skipping form submit binding.');
        }
      }

      // Shared logic to start the quiz after validation
      startQuizFromForm() {
        if (!this.$nombre || !this.$apellido || !this.$cedula || !this.$telefono) {
          console.error('TriviaApp: required form inputs not found. Aborting startQuizFromForm.', {nombre: this.$nombre, apellido: this.$apellido, cedula: this.$cedula, telefono: this.$telefono});
          this.formError.textContent = 'Error interno: no se encontraron los campos del formulario. Contactá al administrador.';
          return;
        }
        this.state.participante = {
          nombre: (this.$nombre.value || '').trim(),
          apellido: (this.$apellido.value || '').trim(),
          cedula: (this.$cedula.value || '').trim(),
          telefono: (this.$telefono.value || '').trim(),
        };
        this.resetQuiz();
        this.showView('quiz');
        this.renderQuestion(0);
      }

      // Handler for the non-submitting Comenzar button
      handleStart() {
        const ok = this.validateForm();
        if (!ok) return;
        this.startQuizFromForm();
      }

      validateForm() {
        let error = '';
        const trim = v => (v || '').trim();
        if (!this.$nombre || !this.$apellido || !this.$cedula || !this.$telefono) {
          console.error('TriviaApp: validateForm called but some inputs are missing', {nombre: this.$nombre, apellido: this.$apellido, cedula: this.$cedula, telefono: this.$telefono});
          this.formError.textContent = 'Error interno: campos del formulario ausentes.';
          return false;
        }
        const nombre = trim(this.$nombre.value);
        const apellido = trim(this.$apellido.value);
        const cedula = trim(this.$cedula.value);
        const telefono = trim(this.$telefono.value);

        // Limpia estados
          ['nombre','apellido','cedula','telefono'].forEach(id => {
            const f = document.getElementById(`field-${id}`);
            if (f && f.classList) f.classList.remove('invalid');
          });

  if (!nombre) { error = 'Por favor ingresá tu nombre.'; const el = document.getElementById('field-nombre'); if (el) el.classList.add('invalid'); }
  else if (!apellido) { error = 'Por favor ingresá tu apellido.'; const el = document.getElementById('field-apellido'); if (el) el.classList.add('invalid'); }
  else if (!cedula) { error = 'Por favor ingresá tu cédula.'; const el = document.getElementById('field-cedula'); if (el) el.classList.add('invalid'); }
  else if (!telefono) { error = 'Por favor ingresá tu teléfono.'; const el = document.getElementById('field-telefono'); if (el) el.classList.add('invalid'); }
        else if (!/^[0-9 .\-]+$/.test(cedula)) { error = 'La cédula debe contener solo números y separadores.'; document.getElementById('field-cedula').classList.add('invalid'); }
        else if (!/^[0-9 +()\-]{7,}$/.test(telefono)) { error = 'El teléfono no parece válido.'; document.getElementById('field-telefono').classList.add('invalid'); }

        this.formError.textContent = error;
        if (error) {
          this.form.classList.remove('shake');
          void this.form.offsetWidth; // restart animation
          this.form.classList.add('shake');
          setTimeout(() => this.form.classList.remove('shake'), 450);
          return false;
        }
        return true;
      }

      // ----- Quiz -----
      bindQuiz() {
        this.$options.addEventListener('click', (e) => {
          const btn = e.target.closest('button.option');
          if (!btn) return;
          const selectedIndex = parseInt(btn.dataset.index, 10);
          this.selectOption(selectedIndex);
        });

        this.$btnNext.addEventListener('click', () => {
          if (this.state.respuestas[this.state.idx] == null) {
            this.$helper.textContent = 'Seleccioná una opción para continuar.';
            this.$helper.classList.remove('shake');
            void this.$helper.offsetWidth;
            this.$helper.classList.add('shake');
            setTimeout(() => this.$helper.classList.remove('shake'), 400);
            return;
          }
          if (this.state.idx >= this.preguntas.length - 1) {
            this.finishQuiz();
          } else {
            this.renderQuestion(this.state.idx + 1);
          }
        });
      }

      resetQuiz() {
        this.state.idx = 0;
        this.state.respuestas = Array(this.preguntas.length).fill(null);
        this.state.puntaje = 0;
        this.$helper.textContent = '';
        this.$btnNext.disabled = true;
      }

      renderQuestion(index) {
        this.state.idx = index;
        const q = this.preguntas[index];
        this.$questionText.textContent = q.pregunta;
        this.$options.innerHTML = '';
        q.opciones.forEach((op, i) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'option btn';
          btn.dataset.index = String(i);
          btn.innerHTML = `${String.fromCharCode(65 + i)}. ${op}`;
          if (this.state.respuestas[index] === i) btn.classList.add('selected');
          this.$options.appendChild(btn);
        });

        // Barra de progreso y textos
        const n = this.preguntas.length;
        this.$progressText.textContent = `Pregunta ${index + 1} de ${n}`;
        this.$progressBar.style.width = `${((index) / n) * 100}%`;
        this.$helper.textContent = '';
        const hasSelection = this.state.respuestas[index] != null;
        this.$btnNext.disabled = !hasSelection;
        this.$btnNext.textContent = index === n - 1 ? 'Finalizar' : 'Siguiente';
      }

      selectOption(i) {
        // Marca selección
        [...this.$options.querySelectorAll('.option')].forEach(btn => btn.classList.remove('selected'));
        const btn = this.$options.querySelector(`.option[data-index="${i}"]`);
        if (btn) btn.classList.add('selected');
        this.state.respuestas[this.state.idx] = i;
        this.$btnNext.disabled = false;
      }

      finishQuiz() {
        const total = this.preguntas.length;
        let score = 0;
        this.state.respuestas.forEach((r, i) => { if (r === this.preguntas[i].correcta) score++; });
        this.state.puntaje = score;
        this.updateResultUI(score, total);
        this.showView('result');
        this.submitToNetSuite();
      }

      updateResultUI(score, total) {
        const pct = Math.round((score / total) * 100);
        this.$scoreValue.textContent = `${score}/${total}`;
        this.$scorePercent.textContent = `${pct}%`;
        let tagClass = 'success';
        let tagText = 'Excelente';
        let msg = '¡Excelente desempeño!';
        if (pct >= 80) { tagClass = 'success'; tagText = 'Excelente'; msg = '¡Excelente! Dominaste esta trivia.'; }
        else if (pct >= 50) { tagClass = 'warn'; tagText = 'Buen intento'; msg = 'Buen intento, estás cerca de la perfección.'; }
        else { tagClass = 'error'; tagText = 'Podés mejorar'; msg = 'Podés mejorar. ¡Volvé a intentarlo!'; }
        this.$scoreTag.className = `tag ${tagClass}`;
        this.$scoreTag.textContent = tagText;
        this.$scoreMessage.textContent = msg;
      }

      // ----- Envío a NetSuite -----
      async submitToNetSuite() {
        const payload = {
          nombre: this.state.participante?.nombre || '',
          apellido: this.state.participante?.apellido || '',
          docNumber: this.state.participante?.cedula || '',
          mobilePhone: this.state.participante?.telefono || '',
          puntaje: this.state.puntaje,
          source: 'TriviaApp',
        };
        this.renderSaving('Guardando datos…');
        this.$btnRetrySend.style.display = 'none';
        try {
          // Build headers; include OAuth Authorization header if inline credentials were set.
          const headers = { 'Content-Type': 'application/json' };
          // if (NS_CONSUMER_KEY && NS_CONSUMER_SECRET && NS_TOKEN_ID && NS_TOKEN_SECRET && !NS_CONSUMER_KEY.includes('INSERT')) {
            try {
              console.warn('TriviaApp: Using client-side OAuth signing. THIS EXPOSES SECRETS IN THE BROWSER. Prefer server-side proxy.');
              // Use absolute URL for signing to ensure the base string contains the NetSuite host
              // const signedUrl = buildUrl(RESTLET_URL_ABS, RESTLET_SCRIPT_ID, RESTLET_DEPLOY_ID, RESTLET_EXTRA_PARAMS);

              const url = this.buildUrl(null, 36, 1); // incluye script/deploy
              const authHeader = await this.buildOAuthHeader({ url, method: 'POST' });

              console.debug('signing absolute URL:', signedUrl);
              const response = await this.httpRequest({
                    method: 'POST',
                    url,
                    headers: {
                      Authorization: authHeader,
                      'Content-Type': 'application/json',
                      Accept: 'application/json',
                    },
                    body: JSON.stringify(payload),
                  });
            } catch (hErr) {
              console.error('TriviaApp: failed to build OAuth header', hErr);
            }
          // }

            // Si tenés un proxy server-side (p.ej. en Node) seteá RESTLET_PROXY_PATH con la ruta relativa.
           /*  // Caso contrario, se usa directamente el host de NetSuite calculado arriba para evitar CORS.
            const RESTLET_PROXY_PATH = '';
            const fetchUrl = RESTLET_PROXY_PATH || buildUrl(RESTLET_URL_ABS, RESTLET_SCRIPT_ID, RESTLET_DEPLOY_ID, RESTLET_EXTRA_PARAMS);
          console.debug('TriviaApp: fetching URL:', fetchUrl);
          let res = await fetch(fetchUrl, {
            method: 'POST',
            // same-origin: send cookies only to our proxy (if any). This is safe for proxy usage.
            credentials: 'same-origin',
            headers,
            body: JSON.stringify(payload),
          }); */

          // If NetSuite returns 401 and we used HMAC-SHA256, retry once with HMAC-SHA1
          /* if (res.status === 401 && headers['Authorization'] && headers['Authorization'].includes('HMAC-SHA256')) {
            console.warn('TriviaApp: received 401 with HMAC-SHA256, retrying once with HMAC-SHA1 for diagnosis');
            try {
              const retryUrl = buildUrl(RESTLET_URL_ABS, RESTLET_SCRIPT_ID, RESTLET_DEPLOY_ID, RESTLET_EXTRA_PARAMS);
              const auth2 = await buildOAuth1Header({
                method: 'POST',
                url: retryUrl,
                consumerKey: NS_CONSUMER_KEY,
                consumerSecret: NS_CONSUMER_SECRET,
                token: NS_TOKEN_ID,
                tokenSecret: NS_TOKEN_SECRET,
                signatureMethod: 'HMAC-SHA1',
                realm: RESTLET_REALM
              });
              const headers2 = Object.assign({}, headers, { Authorization: auth2 });
              const res2 = await fetch(retryUrl, { method: 'POST', credentials: 'same-origin', headers: headers2, body: JSON.stringify(payload) });
              console.debug('TriviaApp: retry response status', res2.status);
              // prefer the successful response if any
              if (res2.ok) res = res2;
            } catch (retryErr) {
              console.error('TriviaApp: retry with HMAC-SHA1 failed', retryErr);
            }
          } */

         /*  let data = null;
          try { data = await res.clone().json(); } catch (_) { data = { raw: await res.text() }; }

          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          const ok = (data && (data.success === true || data.status === 'success')) || res.ok;
          if (ok) {
            const id = data?.id || data?.internalId || '—';
            this.renderSuccess(`Datos guardados correctamente. ID: ${id}`);
          } else {
            throw new Error('Respuesta inesperada del servidor');
          } */
        } catch (err) {
          // Improve error feedback for network/CORS failures
          console.error('Error al guardar en NetSuite:', err);
          if (err instanceof TypeError && err.message === 'Failed to fetch') {
            this.renderError('Error de red/CORS al comunicarse con NetSuite. Verificá que la página está servida desde NetSuite y que el RESTlet es accesible.');
          } else {
            this.renderError(`No se pudo guardar en NetSuite: ${err.message || err}`);
          }
          this.$btnRetrySend.style.display = '';
        }
      }

      bindResult() {
            this.$btnRetrySend.addEventListener('click', () => this.submitToNetSuite());
            this.$btnRestart.addEventListener('click', () => {
              if (this.form && typeof this.form.reset === 'function') this.form.reset();
              else {
                // If no real form exists (preview mode), try to clear known inputs
                if (this.$nombre) this.$nombre.value = '';
                if (this.$apellido) this.$apellido.value = '';
                if (this.$cedula) this.$cedula.value = '';
                if (this.$telefono) this.$telefono.value = '';
              }
              this.formError.textContent = '';
              this.resetQuiz();
              this.showView('form');
            });
      }

      renderSaving(text) {
        this.$saveStatus.innerHTML = `<span class="spinner"></span>${text}`;
      }
      renderSuccess(text) {
        this.$saveStatus.innerHTML = `✅ ${text}`;
      }
      renderError(text) {
        this.$saveStatus.innerHTML = `❌ ${text}`;
      }
    }

    // Inicialización
    (function () {
      const app = new TriviaApp(preguntas);
      app.init();
      // Debug: report which inputs were bound (helps when NL tags render different ids)
      console.debug('TriviaApp: bound inputs', {
        nombre: (app.$nombre && (app.$nombre.name || app.$nombre.id || app.$nombre.tagName)) || null,
        apellido: (app.$apellido && (app.$apellido.name || app.$apellido.id || app.$apellido.tagName)) || null,
        cedula: (app.$cedula && (app.$cedula.name || app.$cedula.id || app.$cedula.tagName)) || null,
        telefono: (app.$telefono && (app.$telefono.name || app.$telefono.id || app.$telefono.tagName)) || null,
      });
    })();

    // Logo load fallback: if the NetSuite-hosted image cannot be loaded (CSP, 404, etc.),
    // replace it with a small branded box showing initials.
    (function handleLogoFallback() {
      const img = document.getElementById('brandLogo');
      if (!img) return;
      // If already loaded successfully, nothing to do
      if (img.complete && img.naturalWidth > 0) return;
      img.addEventListener('error', () => {
        const p = document.createElement('div');
        p.className = 'brand-logo fallback';
        p.textContent = 'EN';
        img.replaceWith(p);
      });
      // Also guard a delayed failure where the browser never fires error but image is 0x0
      setTimeout(() => {
        if (img && (img.naturalWidth === 0 || img.naturalHeight === 0)) {
          const p = document.createElement('div');
          p.className = 'brand-logo fallback';
          p.textContent = 'EN';
          img.replaceWith(p);
        }
      }, 900);
    })();
  </script>
  </NLFORM>
</body>
</html>

